= javascript_include_tag "signup_flow"
= render :partial => 'partials/signup_header'

.container.full-width.blue-bg.no-padding.white.align-center
  %br/ 
  %h1#lets-doit LET'S DO THIS
%br/ 
%br/ 
%br/ 
%br/ 
%br/ 

= form_for :signup, :html => {:id => 'signup-form'}, url: {action: 'create'} do |f| 

  ///////////////////////////////////////////////////
  // ITEM SELECTION /////////////////////////////////
  ///////////////////////////////////////////////////
  %section.text-center#signup-first
    .heading-about.marginbot-20
      .container
        .row
          .col-lg-8.col-lg-offset-2
            .section-heading
              %h2.no-margin Do You Need Packing Supplies?
              %p.align-center (we'll bring these items right to your door)
    .container
      .row
        .div
          .col-md-8.col-md-offset-2.inventory
            %br/ 
            %br/ 
            .row
              = render partial: "partials/list_item_4col_field", locals:{title: "Standard Box", price: "$5/unit", id:"stdbox", field_val: :box_quantity, form: f, imgURL:"http://www.ikea.com/us/en/images/products/samla-box__0144440_PE303768_S4.JPG", description:"22\" x 18\" x 12\" for books, clothing & small items."}
              = render partial: "partials/list_item_4col_field", locals:{title: "Wardrobe Box", price: "$12/unit", id:"warbox", field_val: :wardrobe_box_quantity, form: f, imgURL:"http://www.ikea.com/us/en/images/products/brimnes-wardrobe-with--doors__0140624_PE300605_S4.JPG", description:"24\" x 20\" x 46\" suits, poster tubes & tall items."}
              = render partial: "partials/list_item_4col_field", locals:{title: "Bubble Wrap", price: "$10 / 30ft", id:"bubble", field_val: :bubble_quantity, form: f, imgURL:"http://www.staples-3p.com/s7/is/image/Staples/s0767163_sc7?$splssku$", description:"12\" wide x 30' long. Cocoon your precious items. "}
              = render partial: "partials/list_item_4col_field", locals:{title: "Packing Tape", price: "$5 / 30ft", id:"tape", field_val: :tape_quantity, form: f, imgURL:"http://www.staples-3p.com/s7/is/image/Staples/s0199320_sc7?$splssku$", description:"10\" x 12\" x 15\" to keep your boxex in line."}

          .col-md-6.col-md-offset-3.half-opacity.charges-box
            %br/
            %br/ 
            %br/ 
            .single-line
            %br/ 
            %br/ 
          .col-md-10.col-md-offset-1
            .row
              .col-md-12.charges-box
                .row
                  .col-md-10.col-md-offset-1.confirm-elem.light-blue-bg
                    %h5 Packing Supplies Summary
                    %ul
                      %li#num-stdbox.hidden
                        %span.pull-left> 0
                        \&nbsp; &nbsp;Standard Boxes
                        %i.pull-right.light-gray $6.50/unit
                      %li#num-warbox.hidden
                        %span.pull-left> 0
                        \&nbsp; &nbsp;Wardrobe Boxes
                        %i.pull-right.light-gray $12.00/unit
                      %li#num-bubble.hidden
                        %span.pull-left> 0
                        \&nbsp; &nbsp;Rolls of Bubble Wrap
                        %i.pull-right.light-gray $4.50/unit
                      %li#num-tape.hidden
                        %span.pull-left> 0
                        \&nbsp; &nbsp;Packing Tape
                        %i.pull-right.light-gray $9.50/unit
                      %li#num-tube.hidden
                        %span.pull-left> 0
                        \&nbsp; &nbsp;Art/Poster Tubes
                        %i.pull-right.light-gray $10.00/unit
                      %br/  
                      %li.half-opacity
                        Valet Pickup
                        %span.pull-right Free
                    .single-line
                    %ul
                      %li.heavy-font
                        Subtotal
                        %span#order-subtotal.pull-right $00.00/m
              .col-md-10.col-md-offset-1
                %br/ 
                .col-md-4.bottom-buttons
                  .boxed-gray.continue-button
                    %button.btn.btn-primary.blue-bg.gray-bg{:type => "button"}
                      = link_to "Back", root_path, class:"white"
                .col-md-4.col-md-offset-4.bottom-buttons.charges-box
                  .boxed-gray.continue-button
                    %button.btn.btn-primary.blue-bg.blue-bg-hover#signup-first-btn{:type => "button"}
                      Delivery Details


  ///////////////////////////////////////////////////
  // PICKUP   ///////////////////////////////////////
  ///////////////////////////////////////////////////
  %section.text-center#signup-second.hidden
    .heading-about.marginbot-20
      .container
        .row
          .col-lg-8.col-lg-offset-2
            .section-heading
              %h2.no-margin What Are We Picking Up?
              %p.align-center (you can always edit your pickup or change it when we arrive)

    .col-md-4.col-md-offset-4.half-opacity.charges-box
      %br/ 
      .single-line
    .container
      .row
        .div
          .col-md-8.col-md-offset-2.inventory
            %br/ 
            %br/ 
            .row
              = render partial: "partials/list_item_4col_field", locals:{title: "Boxes", price: "$5/m", id:"box", field_val: :box, form: f, imgURL:"https://s3.amazonaws.com/storage_rails_app_dev/images/cardboard2.png", description:"Any boxes 2' x 2' x 2' or smaller. Packing boxes available for order."}
              = render partial: "partials/list_item_4col_field", locals:{title: "Medium", price: "$12/m", id:"medium", field_val: :medium, form: f, imgURL:"https://s3.amazonaws.com/storage_rails_app_dev/images/bike.png", description:"Wardrobe Boxes, Desks, Lamps, Skis, Bikes, Small Furniture, Equivalent Items"}
              = render partial: "partials/list_item_4col_field", locals:{title: "Large", price: "$20/m", id:"large", field_val: :large, form: f, imgURL:"https://s3.amazonaws.com/storage_rails_app_dev/images/couch.png", description:"Couches, mattresses, desks, tables, dressers, or furniture that takes two to move."}
              = render partial: "partials/list_item_4col_field", locals:{title: "XL Items", price: "$40/m", id:"extra_large", field_val: :box_quantity, form: f, imgURL:"https://s3.amazonaws.com/storage_rails_app_dev/images/table.png", description:"Sectional couches, large dining tables, items over 200lbs or 60 cubic feet"}

          
          .col-md-6.col-md-offset-3.half-opacity.charges-box
            %br/
            %br/ 
            %br/ 
            .single-line
            %br/ 
            %br/ 
          .col-md-10.col-md-offset-1
            .row
              .col-md-12.charges-box
                .row
                  .col-md-10.col-md-offset-1.confirm-elem.light-blue-bg
                    %h5 Pickup Summary
                    %ul
                      %li#num-box.hidden
                        %span.pull-left> 0
                        \&nbsp; &nbsp; Boxes
                        %i.pull-right.light-gray $6.50/unit
                      %li#num-medium.hidden
                        %span.pull-left> 0
                        \&nbsp; &nbsp;Medium Items
                        %i.pull-right.light-gray $12.00/unit
                      %li#num-large.hidden
                        %span.pull-left> 0
                        \&nbsp; &nbsp;Large Items
                        %i.pull-right.light-gray $4.50/unit
                      %li#num-extra_large.hidden
                        %span.pull-left> 0
                        \&nbsp; &nbsp;Extra Large Items
                        %i.pull-right.light-gray $9.50/unit
                      %br/  
                      %li.half-opacity
                        Valet Pickup
                        %span.pull-right Free
                    .single-line
                    %ul
                      %li.heavy-font
                        Subtotal
                        %span#pickup-subtotal.pull-right $00.00/m
              .col-md-10.col-md-offset-1
                %br/ 
                .col-md-4.bottom-buttons
                  .boxed-gray.continue-button
                    %button.btn.btn-primary.blue-bg.gray-bg#signup-second-back{:type => "button"}
                      Back
                .col-md-4.col-md-offset-4.bottom-buttons.charges-box
                  .boxed-gray.continue-button
                    %button.btn.btn-primary.blue-bg.blue-bg-hover#signup-second-btn{:type => "button", disabled: true}
                      Item Pickup
              .col-md-12
                %p.light-gray.onepxhigh#pickup-deliv-instructions (You must schedule at least one pickup or delivery to sign up)
                %br/ 
                %br/ 
  
  ///////////////////////////////////////////////////
  // DELIVERY DETAILS ///////////////////////////////
  ///////////////////////////////////////////////////
  %section.text-center#signup-third.hidden
    .heading-about.marginbot-20
      .container
        .row
          .col-lg-8.col-lg-offset-2
            .section-heading
              %h2.no-margin To Where Are We Delivering?
    .container
      .row
        .div
          .col-md-6.col-md-offset-3.half-opacity.charges-box
            %br/
          .col-md-8.col-md-offset-2
            .row
              = fields_for @user do |field|
                = render partial: "partials/delivery_addr_date", locals: {field:field, f:f, id:"datepicker"}
        .col-md-6.col-md-offset-3.half-opacity.charges-box
          %br/
          %br/ 
          .single-line
          %br/ 
          %br/       
    .container#delivery-time.hidden
      %h2.no-margin When should we drop off the supplies?
      .row
        .div
          .col-md-6.col-md-offset-3.half-opacity.charges-box
            %br/
          .col-md-8.col-md-offset-2
            .row
              = fields_for @user do |field|
                = render partial: "partials/delivery_date_time", locals: {field:field, f:f, id:"delivery_datepicker", select_id:"delivery_time"}


        .col-md-6.col-md-offset-3.half-opacity.charges-box
          %br/
          %br/ 
          .single-line
          %br/ 
          %br/ 
    .container#pickup-time.hidden
      %h2.no-margin When should we schedule the pickup?    
      .row
        .div
          .col-md-6.col-md-offset-3.half-opacity.charges-box
            %br/
          .col-md-8.col-md-offset-2
            .row
              = fields_for @user do |field|
                = render partial: "partials/delivery_date_time", locals: {field:field, f:f, id:"pickup_datepicker", select_id:"pickup_time"}
    .container
      %br/ 
      %br/ 
      %br/ 
      .col-md-3.bottom-buttons
        .boxed-gray.continue-button
          %button.btn.btn-primary.blue-bg.gray-bg#signup-third-back{:type => "button"}
            Back
      .col-md-3.col-md-offset-6.bottom-buttons.charges-box
        .boxed-gray.continue-button
          %button.btn.btn-primary.blue-bg.blue-bg-hover#signup-third-btn{:type => "button", disabled: true}
            Next
          / = f.submit "Confirm Order"              


  ///////////////////////////////////////////////////
  // Signup /////////////////////////////////////////
  ///////////////////////////////////////////////////
  %section.text-center#signup-fourth.hidden
    .heading-about.marginbot-30
      .container
        .row
          .col-lg-8.col-lg-offset-2
            .section-heading
              %h2 Create An Account
    .container
      .row
        .col-lg-6.col-md-offset-3
          .boxed-grey
            .row
              %br/ 
              %br/ 
              = fields_for @user do |userAcct| 
                .col-md-8.col-md-offset-2.form-group.address-form
                  %div.extra-form-padding
                    = userAcct.email_field :email, autofocus: true, class:"form-control", placeholder: "Email Address"
                  %div.extra-form-padding
                    = userAcct.password_field :password, autocomplete: "off", class:"form-control", placeholder: "Password"
                  %div.extra-form-padding
                    = userAcct.password_field :password_confirmation, autocomplete: "off", class:"form-control", placeholder: "Confirm Password"
                .col-md-8.col-md-offset-2.bottom-buttons
                  %a= userAcct.submit "Create Account",:class => "btn btn-skin pull-right", id:"signup-third-btn"                  
                  %a.pointer
                    %h1.btn.btn-default.pull-left#signup-fourth-back Back
            %br/
            %br/ 
    %br/ 
    %br/ 
    %br/ 
    %br/ 
    %br/ 
    %br/ 



= render :partial => "partials/footer"


/ Modal
#myModal.modal.fade{"aria-hidden" => "true", "aria-labelledby" => "myModalLabel", :role => "dialog", :tabindex => "-1"}
  .modal-dialog
    .modal-content
      .modal-header
        %button.close{"data-dismiss" => "modal", :type => "button"}
          %span{"aria-hidden" => "true"} ×
          %span.sr-only Close
        %h4#myModalLabel.modal-title Terms of Service
      .modal-body
        %p Small Items
        %ul
          %li Small Items
          %li Medium Items
        %p Medium Items
        %ul
          %li Small Items
          %li Medium Items
        %p Large Items
        %ul
          %li Small Items
          %li Medium Items
      .modal-footer
        %button.btn.btn-default.pull-left{"data-dismiss" => "modal", :type => "button"} Close
        / %button.btn.btn-primary{:type => "button"} Save changes

:javascript
  
  
  /////////////////////////////////////////////////////////////
  // Prevent "enter" button submission
  /////////////////////////////////////////////////////////////
  $(document).ready(function() {
    $(".quantity-field").keydown(function(event){
      if(event.keyCode == 13) {
        event.preventDefault();
        console.log("QUANTITY CHANGED");
        var field = $(this);
        var id = field.attr("id");
        var idRoot = id.substr(4);
        console.log("#num-"+idRoot+" span");
        var orderEntrySpan = $('#num-'+idRoot+ " span");
        refreshOrder(field.val(), orderEntrySpan);
      }
    });

    var all_form = $(".form-control");
    all_form.on('input', function() {
      checkFormDisableBtn();
    });

  });



  /////////////////////////////////////////////////////////////
  // Makes sure required fields are filled out on address/delivery page
  /////////////////////////////////////////////////////////////
  function checkFormDisableBtn(){
    if ($("#signup-form").data('bootstrapValidator').isValid()){

      // If 
      if((($("#pickup_datepicker").val().length > 0) && ($("#pickup_time").val().length > 0)) || $("#pickup-time").hasClass("hidden")) {
        if((($("#delivery_datepicker").val().length > 0) && ($("#delivery_time").val().length > 0)) || $("#delivery-time").hasClass("hidden")) {
          $("#signup-third-btn").removeAttr("disabled"); 
        }
      }

    } else{
      $("#signup-third-btn").attr("disabled", "disabled"); 
      console.log("no");
    }
  }


  /////////////////////////////////////////////////////////////
  // Makes sure that div sizes are the same height for order items
  /////////////////////////////////////////////////////////////
  function sizeEntriesTheSame(divName){
    var maxHeight = 0;
    var entries = $("." + divName);
    entries.each(function(){
      var thisHeight = $(this).height();
      if (thisHeight > maxHeight){
        maxHeight = thisHeight;
      } 
    });
    entries.css("height", maxHeight);
    console.log("reset size");
  }


  /////////////////////////////////////////////////////////////
  // Increment Text Field
  /////////////////////////////////////////////////////////////
  $(".btn-inc").click(function(){
    console.log("button clicked");
    var id = $(this).attr('id');

    // update text field - incrememnt by one
    var field = $("#txt-"+id);
    var val = $(field).val();
    val = +val + 1;
    $(field).val(val);

    // update subtotal text
    var orderEntrySpan = $('#num-'+id+" span");
    console.log("#num-"+id+" span");
    refreshOrder(val, orderEntrySpan);
  });


  /////////////////////////////////////////////////////////////
  // Changes quantity, updates field when text manually changed
  /////////////////////////////////////////////////////////////
  $(".quantity-field").change(function(){
    console.log("QUANTITY CHANGED");
    var field = $(this);
    var id = field.attr("id");
    var idRoot = id.substr(4);
    console.log("#num-"+idRoot+" span");
    var orderEntrySpan = $('#num-'+idRoot+ " span");
    refreshOrder(field.val(), orderEntrySpan);
  });


  /////////////////////////////////////////////////////////////
  // Rewrites values in Order Summary Field for pickups and deliveries
  /////////////////////////////////////////////////////////////
  function refreshOrder(val, orderEntrySpan){
    console.log("REFERESHING ORDER FOR" + orderEntrySpan);
    orderEntrySpan.html(parseInt(val));
    var orderEntry = orderEntrySpan.parent();
    
    if (val == 0) orderEntry.addClass('hidden');
    else orderEntry.removeClass('hidden');
    
    updatePackingItemsTotal();
    updatePickupTotal();
  }


  /////////////////////////////////////////////////////////////
  // Overwrites subtotal for packing Items.
  // Hides delivery field if no items selected
  /////////////////////////////////////////////////////////////
  function updatePackingItemsTotal(){

    // Number of Boxes
    var numStdBox = $('#txt-stdbox').val();
    var numWarBox = $('#txt-warbox').val();
    var numBubble = $('#txt-bubble').val();
    var numTape = $('#txt-tape').val();

    // Pricing Per Box
    var STDBOX_PRICE =  6.50;
    var WARDROBE_BOX_PRICE =  12.00;
    var BUBBLE_WRAP_PRICE =  4.50;
    var TAPE_PRICE =  9.50;
    var POSTER_TUBE_PRICE =  10.00;

    var total = (numStdBox * STDBOX_PRICE) + (numWarBox * WARDROBE_BOX_PRICE) + (numBubble * BUBBLE_WRAP_PRICE) + (numTape * TAPE_PRICE);
    console.log("total:" + total);
    $('#order-subtotal').text("$" + total+"/m");
    if ((total > 1) && ($("#delivery-time").hasClass("hidden"))) {
      $("#delivery-time").toggleClass("hidden");
      
      // Allow user to continue on
      if (!$("#pickup-deliv-instructions").hasClass("hidden")){
        $("#pickup-deliv-instructions").toggleClass("hidden");
        $("#signup-second-btn").removeAttr("disabled");
      }

    }
  }


  /////////////////////////////////////////////////////////////
  // Overwrites subtotal for pickup order
  // Hides delivery field if no items selected
  /////////////////////////////////////////////////////////////
  function updatePickupTotal(){
    // Number of Boxes
    var numBox = $('#txt-box').val();
    var numMedium = $('#txt-medium').val();
    var numLarge = $('#txt-large').val();
    var numXLarge = $('#txt-extra_large').val();

    // Pricing Per Box
    var BOX_PRICE =  5.00;
    var MEDIUM_PRICE =  12.00;
    var LARGE_PRICE =  20.00;
    var XLARGE_PRICE =  40.00;


    var total = (numBox * BOX_PRICE) + (numMedium * MEDIUM_PRICE) + (numLarge * LARGE_PRICE) + (numXLarge * XLARGE_PRICE);
    console.log("total:" + total);
    $('#pickup-subtotal').text("$" + total+"/m");
    if ((total > 1) && ($("#pickup-time").hasClass("hidden"))){
      $("#pickup-time").toggleClass("hidden");
      
      // Allow user to continue on
      if (!$("#pickup-deliv-instructions").hasClass("hidden")){
        $("#pickup-deliv-instructions").toggleClass("hidden");
        $("#signup-second-btn").removeAttr("disabled");
      }
    }
  }


  /////////////////////////////////////////////////////////////
  // Segues between on-screen, hidden "pages"
  /////////////////////////////////////////////////////////////
  function moveFromTo(fromDiv, toDiv){
    $(fromDiv).toggleClass("hidden");
    $(toDiv).toggleClass("hidden");
    window.scrollTo(0,0);
  }


  /////////////////////////////////////////////////////////////
  // Signup Button Flow - Forward
  /////////////////////////////////////////////////////////////
  $("#signup-first-btn").click(function(){
    $("#lets-doit").parent().hide();
    moveFromTo("#signup-first", "#signup-second");
  })

  $("#signup-second-btn").click(function(e){
    e.preventDefault();
    moveFromTo("#signup-second", "#signup-third");
  })

  $("#signup-third-btn").click(function(e){
    e.preventDefault();
    moveFromTo("#signup-third", "#signup-fourth");
  })

  $("#signup-fourth-btn").click(function(e){
    e.preventDefault();
    moveFromTo("#signup-fourth", "#signup-fifth");
  })


  /////////////////////////////////////////////////////////////
  // Back Buttons
  /////////////////////////////////////////////////////////////

  $("#signup-second-back").click(function(){
    $("#lets-doit").parent().show();
    moveFromTo("#signup-second", "#signup-first");
  })

  $("#signup-third-back").click(function(){
    moveFromTo("#signup-third", "#signup-second");
  })

  $("#signup-fourth-back").click(function(e){
    e.preventDefault();
    moveFromTo("#signup-fourth", "#signup-third");
  })

 



  